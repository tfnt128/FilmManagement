@page "/EditFilm/{FilmName}"
@inject FilmmakerAPI _filmmakerAPI
@inject GenreAPI _genreAPI
@inject FilmAPI _filmAPI
@inject NavigationManager navigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<style>
    @@keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(40px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .edit-film-container {
        animation: slideInUp 0.6s ease-out;
        max-width: 900px;
        margin: 0 auto;
    }

    .edit-film-paper {
        background: linear-gradient(135deg, rgba(30, 30, 30, 0.95) 0%, rgba(20, 20, 20, 0.98) 100%) !important;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
        border-radius: 20px;
    }

        .edit-film-paper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #c82878 0%, #7828c8 100%);
        }

    .film-edit-header {
        padding: 32px 32px 24px 32px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .film-edit-title {
        font-size: 2rem;
        font-weight: 800;
        background: linear-gradient(90deg, #c82878 0%, #7828c8 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 8px;
    }

    .film-edit-subtitle {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.95rem;
    }

    .film-edit-content {
        padding: 32px;
    }

    .film-edit-buttons {
        display: flex;
        gap: 16px;
        justify-content: space-between;
        padding: 24px 32px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        background: rgba(0, 0, 0, 0.2);
    }

    .genre-chips-area {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
        padding: 16px;
        background: rgba(200, 40, 120, 0.05);
        border-radius: 12px;
        border: 1px solid rgba(200, 40, 120, 0.2);
    }

    .edit-field {
        margin-bottom: 28px;
        transition: all 0.3s ease;
    }

        .edit-field:focus-within {
            transform: scale(1.01);
        }

    .loading-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 100px 20px;
    }
</style>

<div class="edit-film-container">
    @if (isLoading)
    {
        <MudPaper Class="edit-film-paper" Elevation="8">
            <div class="loading-screen">
                <MudProgressCircular Color="Color.Secondary" Size="Size.Large" Indeterminate="true" />
                <MudText Typo="Typo.h6" Style="margin-top: 24px; color: rgba(255, 255, 255, 0.7);">
                    Loading film...
                </MudText>
            </div>
        </MudPaper>
    }
    else
    {
        <MudPaper Class="edit-film-paper" Elevation="8">
            <div class="film-edit-header">
                <MudText Class="film-edit-title">
                    <MudIcon Icon="@Icons.Material.Filled.Edit" Style="margin-right: 12px; vertical-align: middle;" />
                    Edit Film
                </MudText>
                <MudText Class="film-edit-subtitle">
                    Update the film information
                </MudText>
            </div>

            <MudForm @ref="form" Class="film-edit-content">
                <div class="edit-field">
                    <MudTextField T="string"
                                  Label="Film Title"
                                  @bind-Value="name"
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Title is required"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Movie" />
                </div>

                <div class="edit-field">
                    <MudSelect T="FilmmakerResponse"
                               Label="Filmmaker"
                               Variant="Variant.Outlined"
                               @bind-Value="FilmmakerFilm"
                               AnchorOrigin="Origin.BottomCenter">
                        @if (filmmakers is not null)
                        {
                            @foreach (var filmmaker in filmmakers)
                            {
                                <MudSelectItem Value="@filmmaker">
                                    @filmmaker.Name
                                </MudSelectItem>
                            }
                        }
                    </MudSelect>
                </div>

                <div class="edit-field">
                    <MudNumericField T="int?"
                                     Label="Release Year"
                                     @bind-Value="releaseYear"
                                     Variant="Variant.Outlined"
                                     Required="true"
                                     RequiredError="Year is required"
                                     Adornment="Adornment.Start"
                                     AdornmentIcon="@Icons.Material.Filled.CalendarToday"
                                     Min="1800"
                                     Max="2100" />
                </div>

                <div class="edit-field">
                    <MudSelect T="GenreResponse"
                               Label="Add Genre"
                               Variant="Variant.Outlined"
                               AnchorOrigin="Origin.BottomCenter">
                        @if (genres is not null)
                        {
                            @foreach (var genre in genres)
                            {
                                <MudSelectItem Value="@genre"
                                               @onclick="@(() => SelectedGenre(genre))">
                                    @genre.Name
                                </MudSelectItem>
                            }
                        }
                    </MudSelect>

                    @if (GenreSelected is not null && GenreSelected.Any())
                    {
                        <div class="genre-chips-area">
                            <MudText Typo="Typo.caption" Style="width: 100%; color: rgba(255, 255, 255, 0.5); margin-bottom: 8px;">
                                Selected genres:
                            </MudText>
                            @foreach (var genre in GenreSelected)
                            {
                                <MudChip T="string"
                                         Color="Color.Secondary"
                                         Size="Size.Medium"
                                         OnClose="@(() => RemoveGenre(genre))">
                                    @genre.Name
                                </MudChip>
                            }
                        </div>
                    }
                </div>
            </MudForm>

            <div class="film-edit-buttons">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.Delete"
                           OnClick="ConfirmDelete"
                           Size="Size.Large">
                    Delete Film
                </MudButton>

                <div style="display: flex; gap: 16px;">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Default"
                               StartIcon="@Icons.Material.Filled.ArrowBack"
                               OnClick="@(() => navigationManager.NavigateTo("/FilmByFilmmaker"))"
                               Size="Size.Large">
                        Cancel
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.Save"
                               OnClick="SaveChanges"
                               Disabled="@isSubmitting"
                               Size="Size.Large">
                        @if (isSubmitting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Style="margin-right: 8px;" />
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>Save Changes</span>
                        }
                    </MudButton>
                </div>
            </div>
        </MudPaper>
    }
</div>

@code {
    private MudForm form;
    private int? releaseYear;
    private string? name;
    private ICollection<FilmmakerResponse>? filmmakers;
    private ICollection<GenreResponse>? genres;
    private List<GenreResponse>? GenreSelected { get; set; } = new();
    private FilmmakerResponse? FilmmakerFilm { get; set; }
    private FilmResponse? Film { get; set; }
    private bool isLoading = true;
    private bool isSubmitting = false;

    [Parameter]
    public string? FilmName { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadFilm();
    }

    private async Task LoadFilm()
    {
        isLoading = true;
        await Task.Delay(300);

        filmmakers = await _filmmakerAPI.GetFilmmakersAsync();
        genres = await _genreAPI.GetGenresAsync();

        Film = await _filmAPI.GetFilmByNameAsync(FilmName!);
        releaseYear = Film!.ReleaseYear;
        name = Film!.Name;
        FilmmakerFilm = new FilmmakerResponse(Film.FilmmakerId, Film.FilmmakerName, "", "");

        isLoading = false;
    }

    private void SelectedFilmmaker(FilmmakerResponse filmmaker)
    {
        FilmmakerFilm = filmmaker;
    }


    private void SelectedGenre(GenreResponse genre)
    {
        if (GenreSelected is not null && !GenreSelected.Contains(genre))
        {
            GenreSelected.Add(genre);
            Snackbar.Add($"Genre '{genre.Name}' added!", Severity.Success);
        }
    }

    private void RemoveGenre(GenreResponse genre)
    {
        GenreSelected?.Remove(genre);
        Snackbar.Add($"Genre '{genre.Name}' removed", Severity.Info);
    }

    private async Task SaveChanges()
    {
        await form.Validate();
        if (!form.IsValid)
        {
            Snackbar.Add("Please fill in all required fields", Severity.Warning);
            return;
        }

        isSubmitting = true;
        try
        {
            Snackbar.Add("Film updated successfully!", Severity.Success);
            await Task.Delay(500);
            navigationManager.NavigateTo("/FilmByFilmmaker");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating film: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task ConfirmDelete()
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirm Deletion",
            $"Are you sure you want to delete the film '{name}'? This action cannot be undone.",
            yesText: "Delete", cancelText: "Cancel",
            options: new DialogOptions { MaxWidth = MaxWidth.Small });

        if (result == true)
        {
            await Delete();
        }
    }

    public async Task Delete()
    {
        try
        {
            await _filmAPI.DeleteFilmAsync(Film!.Id);
            Snackbar.Add("Film deleted successfully!", Severity.Success);
            await Task.Delay(500);
            navigationManager.NavigateTo("/FilmByFilmmaker");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting film: {ex.Message}", Severity.Error);
        }
    }
}
