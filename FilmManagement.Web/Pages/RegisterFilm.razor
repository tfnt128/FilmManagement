@page "/RegisterFilm"
@inject FilmmakerAPI _filmmakerAPI
@inject GenreAPI _genreAPI
@inject FilmAPI _filmAPI
@inject NavigationManager navigationManager
@inject ISnackbar Snackbar

<style>
    @@keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(40px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .register-film-container {
        animation: slideInUp 0.6s ease-out;
        max-width: 900px;
        margin: 0 auto;
    }

    .film-form-paper {
        background: linear-gradient(135deg, rgba(30,30,30,0.95) 0%, rgba(20,20,20,0.98) 100%) !important;
        border: 1px solid rgba(255,255,255,0.1);
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
        border-radius: 20px;
    }

        .film-form-paper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #c82878 0%, #7828c8 100%);
        }

    .film-header {
        padding: 32px 32px 24px 32px;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .film-title {
        font-size: 2rem;
        font-weight: 800;
        background: linear-gradient(90deg, #c82878 0%, #7828c8 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 8px;
    }

    .film-subtitle {
        color: rgba(255,255,255,0.6);
        font-size: 0.95rem;
    }

    .film-content {
        padding: 32px;
    }

    .upload-area {
        border: 2px dashed rgba(120, 40, 200, 0.3);
        border-radius: 16px;
        padding: 32px;
        text-align: center;
        transition: all 0.3s ease;
        background: rgba(120, 40, 200, 0.05);
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

        .upload-area:hover {
            border-color: rgba(120, 40, 200, 0.6);
            background: rgba(120, 40, 200, 0.1);
            transform: scale(1.02);
        }

    .image-preview {
        border-radius: 16px;
        overflow: hidden;
        border: 3px solid rgba(120,40,200,0.3);
        box-shadow: 0 8px 32px rgba(120,40,200,0.3);
        transition: all 0.3s ease;
        background: rgba(0,0,0,0.3);
    }

        .image-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 48px rgba(120,40,200,0.5);
        }

    .upload-icon {
        font-size: 80px;
        background: linear-gradient(135deg, #7828c8 0%, #c82878 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 16px;
    }

    .film-buttons {
        display: flex;
        gap: 16px;
        justify-content: flex-end;
        padding: 24px 32px;
        border-top: 1px solid rgba(255,255,255,0.05);
        background: rgba(0,0,0,0.2);
    }

    .input-section {
        margin-bottom: 28px;
        transition: all 0.3s ease;
    }

    .section-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: rgba(255,255,255,0.7);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
</style>

<div class="register-film-container">
    <MudPaper Class="film-form-paper" Elevation="8">
        <div class="film-header">
            <MudText Class="film-title">
                <MudIcon Icon="@Icons.Material.Filled.MovieCreation" Style="margin-right: 12px; vertical-align: middle;" />
                Film Registration
            </MudText>
            <MudText Class="film-subtitle">
                Add a new film to your library
            </MudText>
        </div>

        <MudForm @ref="form" Class="film-content">
            <div class="input-section">
                <MudTextField T="string"
                              Label="Film Title"
                              @bind-Value="name"
                              Variant="Variant.Outlined"
                              Required="true"
                              RequiredError="The title is required"
                              HelperText="Enter the full title of the film"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Movie" />
            </div>

            <div class="input-section">
                <div class="section-label">
                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" />
                    <span>Filmmaker</span>
                </div>
                <MudSelect T="FilmmakerResponse"
                           Label="Select Filmmaker"
                           Variant="Variant.Outlined"
                           ValueChanged="SelectedFilmmaker">
                    @if (filmmakers is not null)
                    {
                        @foreach (var filmmaker in filmmakers)
                        {
                            <MudSelectItem Value="@filmmaker">@filmmaker.Name</MudSelectItem>
                        }
                    }
                </MudSelect>
            </div>

            <div class="input-section">
                <MudNumericField T="int"
                                 Label="Release Year"
                                 @bind-Value="releaseYear"
                                 Variant="Variant.Outlined"
                                 Required="true"
                                 RequiredError="The release year is required"
                                 HelperText="Ex: 2024"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.CalendarToday"
                                 Min="1800"
                                 Max="2100" />
            </div>

            <div class="input-section">
                <div class="section-label">
                    <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Small" />
                    <span>Film Genres</span>
                </div>
                <MudSelect T="GenreResponse"
                           Value="selectedGenreTemp"
                           ValueChanged="@((GenreResponse value) => SelectedGenre(value))">
                    @foreach (var genre in genres)
                    {
                        <MudSelectItem Value="@genre">@genre.Name</MudSelectItem>
                    }
                </MudSelect>

                @if (GenreSelected is not null && GenreSelected.Any())
                {
                    <div class="genre-chip-container">
                        <MudText Typo="Typo.caption" Style="width: 100%; color: rgba(255,255,255,0.5); margin-bottom: 8px;">
                            Selected genres:
                        </MudText>
                        @foreach (var genre in GenreSelected)
                        {
                            <MudChip T="string" Color="Color.Primary" Size="Size.Medium"
                                     OnClose="@(() => RemoveGenre(genre))">
                                @genre.Name
                            </MudChip>
                        }
                    </div>
                }
            </div>

            @if (!string.IsNullOrEmpty(fileImage))
            {
                <MudText Typo="Typo.subtitle2" Style="margin-bottom: 12px; color: rgba(255,255,255,0.7);">
                    <MudIcon Icon="@Icons.Material.Filled.Image" Size="Size.Small" Style="margin-right: 8px;" />
                    Poster Preview
                </MudText>
                <div style="display: flex; justify-content: center; margin-bottom: 24px;">
                    <MudImage Src="@fileImage" Class="image-preview" Width="300" Height="300" ObjectFit="ObjectFit.Cover" />
                </div>
            }

            
        </MudForm>

        <div class="film-buttons">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       StartIcon="@Icons.Material.Filled.ArrowBack"
                       OnClick="@(() => navigationManager.NavigateTo("/FilmByFilmmaker"))"
                       Size="Size.Large">
                Cancel
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Secondary"
                       StartIcon="@Icons.Material.Filled.Save"
                       OnClick="Register"
                       Disabled="@isSubmitting"
                       Size="Size.Large">
                @if (isSubmitting)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Style="margin-right: 8px;" />
                    <span>Saving...</span>
                }
                else
                {
                    <span>Register Film</span>
                }
            </MudButton>
        </div>
    </MudPaper>
</div>

@code {
    private MudForm form;
    private int releaseYear;
    private string? name;
    private ICollection<FilmmakerResponse>? filmmakers;
    private ICollection<GenreResponse>? genres;
    private List<GenreResponse> GenreSelected { get; set; } = new();
    private FilmmakerResponse? FilmmakerFilm;
    private bool isSubmitting = false;

    private string? fileImage;

    protected override async Task OnInitializedAsync()
    {
        filmmakers = await _filmmakerAPI.GetFilmmakersAsync();
        genres = await _genreAPI.GetGenresAsync();
    }

    private void SelectedFilmmaker(FilmmakerResponse filmmaker) => FilmmakerFilm = filmmaker;

    private GenreResponse? selectedGenreTemp;

    private void SelectedGenre(GenreResponse genre)
    {
        if (genre is not null && !GenreSelected.Contains(genre))
        {
            GenreSelected.Add(genre);
            Snackbar.Add($"Genre '{genre.Name}' added!", Severity.Success);
            selectedGenreTemp = null;
        }
    }

    private void RemoveGenre(GenreResponse genre)
    {
        GenreSelected.Remove(genre);
        Snackbar.Add($"Genre '{genre.Name}' removed", Severity.Info);
    }

    private async Task UploadFile(IBrowserFile file)
    {
        try
        {
            long maxFileSize = 1024 * 1024 * 15;
            var format = file.ContentType;
            using var fileStream = file.OpenReadStream(maxFileSize);
            using var memoryStream = new MemoryStream();
            await fileStream.CopyToAsync(memoryStream);
            var base64 = Convert.ToBase64String(memoryStream.ToArray());
            fileImage = $"data:{format};base64,{base64}";
            Snackbar.Add("Image uploaded successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error uploading image: {ex.Message}", Severity.Error);
        }
    }

    public async Task Register()
    {
        await form.Validate();
        if (!form.IsValid)
        {
            Snackbar.Add("Please fill in all required fields", Severity.Warning);
            return;
        }

        if (FilmmakerFilm is null)
        {
            Snackbar.Add("Please select a filmmaker", Severity.Warning);
            return;
        }

        if (GenreSelected is null || !GenreSelected.Any())
        {
            Snackbar.Add("Please add at least one genre", Severity.Warning);
            return;
        }


        isSubmitting = true;
        try
        {
            var genreRequests = GenreSelected.Select(g => new GenreRequest(g.Name, g.Description)).ToList();
            var filmRequest = new FilmRequest(name!, FilmmakerFilm.Id, releaseYear, genreRequests);

            await _filmAPI.AddFilmAsync(filmRequest);
            Snackbar.Add("Film registered successfully!", Severity.Success);
            await Task.Delay(500);
            navigationManager.NavigateTo("/FilmByFilmmaker");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error registering film: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
